<!DOCTYPE html>
<html>
<head>
  <title>Auth Debug - StyleMCP</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    body { font-family: monospace; padding: 20px; background: #1a1a1a; color: #0f0; }
    pre { background: #000; padding: 15px; border-radius: 5px; overflow-x: auto; }
    h2 { color: #fff; }
    .error { color: #f55; }
    .success { color: #5f5; }
    button { padding: 10px 20px; margin: 5px; font-size: 16px; cursor: pointer; }
  </style>
</head>
<body>
  <h1>üîç Auth Debug</h1>
  
  <h2>URL Info</h2>
  <pre id="urlInfo"></pre>
  
  <h2>Hash Params</h2>
  <pre id="hashParams"></pre>
  
  <h2>Session Status</h2>
  <pre id="sessionStatus">Checking...</pre>
  
  <h2>Auth Events</h2>
  <pre id="authEvents"></pre>
  
  <h2>Actions</h2>
  <button onclick="testGitHub()">Test GitHub Login</button>
  <button onclick="testGoogle()">Test Google Login</button>
  <button onclick="checkSession()">Check Session</button>
  <button onclick="signOut()">Sign Out</button>
  <button onclick="window.location.href='/dashboard.html'">Go to Dashboard</button>

  <script>
    const SUPABASE_URL = 'https://orbliwjewqlnnutykozw.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im9yYmxpd2pld3Fsbm51dHlrb3p3Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjkyNzE5MTEsImV4cCI6MjA4NDg0NzkxMX0.z2xrGw-3UqOHTQ28g7b83vBsavt9rDDP61MKo9I_ZSQ';
    const sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
    
    const events = [];
    
    function log(msg) {
      events.push(new Date().toISOString().substr(11, 12) + ' ' + msg);
      document.getElementById('authEvents').textContent = events.join('\n');
    }
    
    // Show URL info
    document.getElementById('urlInfo').textContent = JSON.stringify({
      href: window.location.href,
      origin: window.location.origin,
      pathname: window.location.pathname,
      hash: window.location.hash,
      search: window.location.search
    }, null, 2);
    
    // Parse hash params
    const hashParams = new URLSearchParams(window.location.hash.substring(1));
    const hashObj = {};
    for (const [key, value] of hashParams) {
      hashObj[key] = key.includes('token') ? value.substring(0, 20) + '...' : value;
    }
    document.getElementById('hashParams').textContent = JSON.stringify(hashObj, null, 2) || '(empty)';
    
    // Listen for auth changes
    sb.auth.onAuthStateChange((event, session) => {
      log('AUTH EVENT: ' + event + ' - user: ' + (session?.user?.email || 'none'));
      updateSessionStatus();
    });
    
    async function updateSessionStatus() {
      const { data: { session }, error } = await sb.auth.getSession();
      const el = document.getElementById('sessionStatus');
      if (error) {
        el.className = 'error';
        el.textContent = 'Error: ' + JSON.stringify(error, null, 2);
      } else if (session) {
        el.className = 'success';
        el.textContent = JSON.stringify({
          user: session.user.email,
          provider: session.user.app_metadata.provider,
          expires_at: new Date(session.expires_at * 1000).toISOString(),
          access_token: session.access_token.substring(0, 20) + '...'
        }, null, 2);
      } else {
        el.className = '';
        el.textContent = 'No session';
      }
    }
    
    async function checkSession() {
      log('Manual session check...');
      await updateSessionStatus();
    }
    
    async function testGitHub() {
      log('Starting GitHub OAuth...');
      const { data, error } = await sb.auth.signInWithOAuth({
        provider: 'github',
        options: { redirectTo: window.location.origin + '/auth-debug.html' }
      });
      log('OAuth result: ' + JSON.stringify({ data, error }));
    }
    
    async function testGoogle() {
      log('Starting Google OAuth...');
      const { data, error } = await sb.auth.signInWithOAuth({
        provider: 'google',
        options: { redirectTo: window.location.origin + '/auth-debug.html' }
      });
      log('OAuth result: ' + JSON.stringify({ data, error }));
    }
    
    async function signOut() {
      log('Signing out...');
      await sb.auth.signOut();
      log('Signed out');
      await updateSessionStatus();
    }
    
    // Initial check
    log('Page loaded');
    updateSessionStatus();
  </script>
</body>
</html>
