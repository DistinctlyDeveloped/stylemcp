<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Dashboard - StyleMCP</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    *{margin:0;padding:0;box-sizing:border-box}
    :root{--bg:#0a0a0b;--bg-elevated:#141416;--bg-card:#1a1a1e;--border:#2a2a2e;--text:#fafafa;--text-muted:#a1a1aa;--accent:#6366f1;--accent-hover:#818cf8;--green:#22c55e;--yellow:#eab308;--red:#ef4444}
    body{font-family:'Inter',-apple-system,sans-serif;background:var(--bg);color:var(--text);line-height:1.6;-webkit-font-smoothing:antialiased}

    .layout{display:flex;min-height:100vh}
    .sidebar{width:240px;background:var(--bg-elevated);border-right:1px solid var(--border);padding:24px;position:fixed;height:100vh}
    .sidebar-logo{font-weight:700;font-size:1.25rem;color:var(--text);text-decoration:none;display:flex;align-items:center;gap:8px;margin-bottom:32px}
    .logo-icon{width:32px;height:32px;background:linear-gradient(135deg,var(--accent) 0%,#a855f7 100%);border-radius:8px;display:flex;align-items:center;justify-content:center}

    .nav-link{display:flex;align-items:center;gap:12px;padding:10px 12px;color:var(--text-muted);text-decoration:none;font-size:0.9rem;border-radius:8px;margin-bottom:4px;transition:all 0.2s}
    .nav-link:hover{background:var(--bg-card);color:var(--text)}
    .nav-link.active{background:var(--accent);color:white}
    .nav-link svg{width:18px;height:18px}

    .sidebar-footer{position:absolute;bottom:24px;left:24px;right:24px}
    .user-info{display:flex;align-items:center;gap:12px;padding:12px;background:var(--bg-card);border-radius:8px;margin-bottom:12px}
    .user-avatar{width:36px;height:36px;background:var(--accent);border-radius:50%;display:flex;align-items:center;justify-content:center;font-weight:600}
    .user-email{font-size:0.85rem;color:var(--text-muted);overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
    .btn-logout{display:block;width:100%;padding:10px;background:transparent;border:1px solid var(--border);color:var(--text-muted);border-radius:8px;font-size:0.9rem;cursor:pointer;transition:all 0.2s}
    .btn-logout:hover{background:var(--bg-card);color:var(--text)}

    .main{flex:1;margin-left:240px;padding:32px 48px}
    .page-header{margin-bottom:32px}
    .page-header h1{font-size:1.75rem;font-weight:700;margin-bottom:8px}
    .page-header p{color:var(--text-muted)}

    .stats-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:20px;margin-bottom:32px}
    @media(max-width:1200px){.stats-grid{grid-template-columns:repeat(2,1fr)}}

    .stat-card{background:var(--bg-card);border:1px solid var(--border);border-radius:12px;padding:24px}
    .stat-label{font-size:0.85rem;color:var(--text-muted);margin-bottom:8px}
    .stat-value{font-size:2rem;font-weight:700}
    .stat-value.green{color:var(--green)}
    .stat-value.yellow{color:var(--yellow)}
    .stat-value.red{color:var(--red)}
    .stat-sub{font-size:0.85rem;color:var(--text-muted);margin-top:4px}

    .card{background:var(--bg-card);border:1px solid var(--border);border-radius:12px;padding:24px;margin-bottom:24px}
    .card-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:20px}
    .card-title{font-size:1.1rem;font-weight:600}

    .api-key-box{display:flex;align-items:center;gap:12px;background:var(--bg-elevated);border:1px solid var(--border);border-radius:8px;padding:12px 16px}
    .api-key{font-family:'JetBrains Mono',monospace;font-size:0.9rem;flex-grow:1}
    .api-key.hidden{color:var(--text-muted)}
    .btn-icon{background:transparent;border:none;color:var(--text-muted);cursor:pointer;padding:8px;border-radius:6px;transition:all 0.2s}
    .btn-icon:hover{background:var(--bg-card);color:var(--text)}

    .progress-bar{height:8px;background:var(--bg-elevated);border-radius:4px;overflow:hidden;margin-top:16px}
    .progress-fill{height:100%;background:var(--accent);border-radius:4px;transition:width 0.3s}
    .progress-fill.warning{background:var(--yellow)}
    .progress-fill.danger{background:var(--red)}

    .tier-badge{display:inline-block;padding:4px 12px;border-radius:50px;font-size:0.8rem;font-weight:600;text-transform:uppercase}
    .tier-badge.free{background:rgba(161,161,170,0.2);color:var(--text-muted)}
    .tier-badge.pro{background:rgba(99,102,241,0.2);color:var(--accent)}
    .tier-badge.team{background:rgba(168,85,247,0.2);color:#a855f7}
    .tier-badge.enterprise{background:rgba(34,197,94,0.2);color:var(--green)}

    .btn{display:inline-flex;align-items:center;gap:8px;padding:10px 20px;border-radius:8px;font-weight:500;font-size:0.9rem;text-decoration:none;transition:all 0.2s;cursor:pointer;border:none}
    .btn-primary{background:var(--accent);color:white}
    .btn-primary:hover{background:var(--accent-hover)}
    .btn-secondary{background:var(--bg-elevated);color:var(--text);border:1px solid var(--border)}
    .btn-secondary:hover{border-color:var(--text-muted)}

    .empty-state{text-align:center;padding:48px;color:var(--text-muted)}

    .loading{display:flex;align-items:center;justify-content:center;min-height:400px}
    .spinner{width:32px;height:32px;border:3px solid var(--border);border-top-color:var(--accent);border-radius:50%;animation:spin 1s linear infinite}
    @keyframes spin{to{transform:rotate(360deg)}}

    @media(max-width:768px){
      .sidebar{display:none}
      .main{margin-left:0;padding:24px}
      .stats-grid{grid-template-columns:1fr}
    }

    /* Welcome Modal */
    .modal{position:fixed;inset:0;z-index:200;display:flex;align-items:center;justify-content:center;padding:24px}
    .modal.hidden{display:none}
    .modal-backdrop{position:absolute;inset:0;background:rgba(0,0,0,0.7);backdrop-filter:blur(4px)}
    .modal-content{position:relative;background:var(--bg-card);border:1px solid var(--border);border-radius:20px;padding:40px;max-width:480px;width:100%;text-align:center;animation:modalIn 0.3s ease}
    @keyframes modalIn{from{opacity:0;transform:scale(0.95)}to{opacity:1;transform:scale(1)}}
    .modal-close{position:absolute;top:16px;right:16px;background:none;border:none;color:var(--text-muted);font-size:24px;cursor:pointer;padding:8px;line-height:1}
    .modal-close:hover{color:var(--text)}
    .modal-icon{font-size:48px;margin-bottom:16px}
    .modal-content h2{font-size:1.5rem;margin-bottom:8px}
    .modal-content p{color:var(--text-muted);margin-bottom:32px}
    .goal-grid{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    .goal-btn{background:var(--bg-elevated);border:2px solid var(--border);border-radius:12px;padding:16px;text-align:left;cursor:pointer;transition:all 0.2s}
    .goal-btn:hover{border-color:var(--accent);background:rgba(99,102,241,0.05)}
    .goal-btn.selected{border-color:var(--accent);background:rgba(99,102,241,0.1)}
    .goal-emoji{font-size:24px;display:block;margin-bottom:8px}
    .goal-title{display:block;font-weight:600;color:var(--text);font-size:0.9rem}
    .goal-desc{display:block;font-size:0.75rem;color:var(--text-muted);margin-top:4px}

    /* Onboarding Checklist */
    .onboarding-card{background:var(--bg-card);border:1px solid var(--border);border-radius:12px;margin-bottom:24px;overflow:hidden;position:relative}
    .onboarding-card.hidden{display:none}
    .onboarding-progress{height:3px;background:var(--bg-elevated)}
    .onboarding-progress-fill{height:100%;background:linear-gradient(90deg,var(--accent),#a855f7);transition:width 0.5s ease}
    .onboarding-dismiss{position:absolute;top:12px;right:12px;background:none;border:none;color:var(--text-muted);font-size:18px;cursor:pointer;padding:4px 8px;line-height:1}
    .onboarding-dismiss:hover{color:var(--text)}
    .onboarding-header{padding:20px 24px 12px}
    .onboarding-header h3{font-size:1rem;display:flex;align-items:center;gap:8px}
    .onboarding-header span{font-weight:normal;color:var(--text-muted);font-size:0.85rem}
    .onboarding-steps{padding:0 16px}
    .onboarding-step{display:flex;align-items:center;gap:12px;padding:12px;border-radius:8px;cursor:pointer;transition:background 0.2s}
    .onboarding-step:hover{background:var(--bg-elevated)}
    .onboarding-step.completed{opacity:0.6}
    .onboarding-step.completed .step-indicator{background:var(--green);color:white}
    .onboarding-step.completed .step-indicator::after{content:"‚úì";position:absolute;font-size:12px}
    .onboarding-step.completed .step-indicator span{visibility:hidden}
    .step-indicator{width:28px;height:28px;border-radius:50%;background:var(--bg-elevated);border:2px solid var(--border);display:flex;align-items:center;justify-content:center;font-size:0.8rem;font-weight:600;color:var(--text-muted);flex-shrink:0;position:relative}
    .step-content{flex-grow:1}
    .step-title{font-weight:500;font-size:0.9rem}
    .step-desc{font-size:0.75rem;color:var(--text-muted)}
    .step-arrow{color:var(--text-muted);opacity:0;transition:opacity 0.2s}
    .onboarding-step:hover .step-arrow{opacity:1}
    .onboarding-step.completed .step-arrow{display:none}
    .onboarding-cta{display:block;width:calc(100% - 32px);margin:16px;padding:12px;background:var(--accent);color:white;border:none;border-radius:8px;font-weight:500;cursor:pointer;transition:background 0.2s}
    .onboarding-cta:hover{background:var(--accent-hover)}
    .onboarding-complete{text-align:center;padding:24px}
    .onboarding-complete h3{color:var(--green);margin-bottom:8px}
  </style>
</head>
<body>
  <div class="layout">
    <nav class="sidebar">
      <a href="/" class="sidebar-logo"><div class="logo-icon">S</div>StyleMCP</a>

      <a href="/dashboard.html" class="nav-link active">
        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"/></svg>
        Dashboard
      </a>
      <a href="/docs.html" class="nav-link">
        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253"/></svg>
        Documentation
      </a>
      <a href="/pricing.html" class="nav-link">
        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h18M7 15h1m4 0h1m-7 4h12a3 3 0 003-3V8a3 3 0 00-3-3H6a3 3 0 00-3 3v8a3 3 0 003 3z"/></svg>
        Billing
      </a>

      <div class="sidebar-footer">
        <div class="user-info">
          <div class="user-avatar" id="userAvatar">?</div>
          <div class="user-email" id="userEmail">Loading...</div>
        </div>
        <button class="btn-logout" id="logoutBtn">Sign Out</button>
      </div>
    </nav>

    <main class="main">
      <div id="loading" class="loading">
        <div class="spinner"></div>
      </div>

      <!-- Welcome Modal -->
      <div id="welcomeModal" class="modal hidden">
        <div class="modal-backdrop"></div>
        <div class="modal-content">
          <button class="modal-close" onclick="dismissWelcome()">&times;</button>
          <div class="modal-icon">‚ú®</div>
          <h2>Welcome to StyleMCP! üëã</h2>
          <p>Let's personalize your experience. What brings you here?</p>
          <div class="goal-grid">
            <button class="goal-btn" onclick="selectGoal('ai-agents')">
              <span class="goal-emoji">ü§ñ</span>
              <span class="goal-title">AI Agents</span>
              <span class="goal-desc">Keep agent outputs on-brand</span>
            </button>
            <button class="goal-btn" onclick="selectGoal('content-team')">
              <span class="goal-emoji">‚úçÔ∏è</span>
              <span class="goal-title">Content Team</span>
              <span class="goal-desc">Enforce style guide rules</span>
            </button>
            <button class="goal-btn" onclick="selectGoal('developer')">
              <span class="goal-emoji">üíª</span>
              <span class="goal-title">Developer</span>
              <span class="goal-desc">Integrate brand validation</span>
            </button>
            <button class="goal-btn" onclick="selectGoal('explore')">
              <span class="goal-emoji">üîç</span>
              <span class="goal-title">Just Exploring</span>
              <span class="goal-desc">See what StyleMCP can do</span>
            </button>
          </div>
        </div>
      </div>

      <div id="dashboard" style="display:none">
        <!-- Onboarding Checklist -->
        <div id="onboardingChecklist" class="onboarding-card">
          <div class="onboarding-progress">
            <div class="onboarding-progress-fill" id="progressFill" style="width:0%"></div>
          </div>
          <button class="onboarding-dismiss" onclick="dismissChecklist()">&times;</button>
          <div class="onboarding-header">
            <h3>Getting Started <span id="checklistProgress">0/4</span></h3>
          </div>
          <div class="onboarding-steps">
            <div class="onboarding-step" id="step1" onclick="goToStep(1)">
              <div class="step-indicator">1</div>
              <div class="step-content">
                <div class="step-title">Copy your API key</div>
                <div class="step-desc">You'll need this to make requests</div>
              </div>
              <div class="step-arrow">‚Üí</div>
            </div>
            <div class="onboarding-step" id="step2" onclick="goToStep(2)">
              <div class="step-indicator">2</div>
              <div class="step-content">
                <div class="step-title">Make your first API call</div>
                <div class="step-desc">Try the validation endpoint</div>
              </div>
              <div class="step-arrow">‚Üí</div>
            </div>
            <div class="onboarding-step" id="step3" onclick="goToStep(3)">
              <div class="step-indicator">3</div>
              <div class="step-content">
                <div class="step-title">Explore style packs</div>
                <div class="step-desc">See available brand rules</div>
              </div>
              <div class="step-arrow">‚Üí</div>
            </div>
            <div class="onboarding-step" id="step4" onclick="goToStep(4)">
              <div class="step-indicator">4</div>
              <div class="step-content">
                <div class="step-title">Read the docs</div>
                <div class="step-desc">Learn all the features</div>
              </div>
              <div class="step-arrow">‚Üí</div>
            </div>
          </div>
          <button class="onboarding-cta" id="nextStepBtn" onclick="goToNextStep()">Copy API Key ‚Üí</button>
        </div>

        <div class="page-header">
          <h1>Dashboard</h1>
          <p>Monitor your API usage and manage your account</p>
        </div>

        <div class="stats-grid">
          <div class="stat-card">
            <div class="stat-label">Current Plan</div>
            <div class="stat-value"><span class="tier-badge" id="tierBadge">Free</span></div>
            <div class="stat-sub" id="planActions"><a href="/pricing.html" style="color:var(--accent)">Upgrade</a></div>
          </div>
          <div class="stat-card">
            <div class="stat-label">Requests This Month</div>
            <div class="stat-value" id="usedCount">0</div>
            <div class="stat-sub">of <span id="limitCount">1,000</span></div>
          </div>
          <div class="stat-card">
            <div class="stat-label">Remaining</div>
            <div class="stat-value green" id="remainingCount">1,000</div>
            <div class="stat-sub">Resets <span id="resetDate">Feb 1</span></div>
          </div>
          <div class="stat-card">
            <div class="stat-label">Usage</div>
            <div class="stat-value" id="usagePercent">0%</div>
            <div class="progress-bar"><div class="progress-fill" id="progressBar" style="width:0%"></div></div>
          </div>
        </div>

        <div class="card">
          <div class="card-header">
            <div class="card-title">API Key</div>
            <button class="btn btn-secondary" id="regenerateBtn" style="display:none">Regenerate</button>
          </div>
          <div class="api-key-box">
            <code class="api-key hidden" id="apiKey">sk_‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢</code>
            <button class="btn-icon" id="toggleKeyBtn" title="Show/Hide">
              <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"/></svg>
            </button>
            <button class="btn-icon" id="copyKeyBtn" title="Copy">
              <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"/></svg>
            </button>
          </div>
          <p style="margin-top:16px;color:var(--text-muted);font-size:0.9rem">Include this key in your API requests using the <code style="background:var(--bg-elevated);padding:2px 6px;border-radius:4px">X-Api-Key</code> header.</p>
        </div>

        <div class="card">
          <div class="card-header">
            <div class="card-title">Quick Start</div>
          </div>
          <div style="background:var(--bg-elevated);border-radius:8px;padding:16px;font-family:'JetBrains Mono',monospace;font-size:0.85rem;overflow-x:auto">
<pre style="margin:0">curl -X POST https://stylemcp.com/api/validate \
  -H "Content-Type: application/json" \
  -H "X-Api-Key: <span id="curlApiKey">YOUR_API_KEY</span>" \
  -d '{"text": "Click here to learn more!"}'</pre>
          </div>
        </div>
      </div>
    </main>
  </div>

  <script>
    // Configuration - Replace with your Supabase project details
    const SUPABASE_URL = 'https://orbliwjewqlnnutykozw.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im9yYmxpd2pld3Fsbm51dHlrb3p3Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjkyNzE5MTEsImV4cCI6MjA4NDg0NzkxMX0.z2xrGw-3UqOHTQ28g7b83vBsavt9rDDP61MKo9I_ZSQ';

    // Initialize Supabase client
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    let currentUser = null;
    let userProfile = null;
    let apiKeyVisible = false;

    async function init() {
      // Check auth state
      const { data: { session } } = await supabase.auth.getSession();

      if (!session) {
        window.location.href = '/login.html';
        return;
      }

      currentUser = session.user;

      // Get profile and usage
      await loadProfile();
      await loadUsage();

      // Show dashboard
      document.getElementById('loading').style.display = 'none';
      document.getElementById('dashboard').style.display = 'block';
    }

    async function loadProfile() {
      const { data, error } = await supabase
        .from('profiles')
        .select('*')
        .eq('id', currentUser.id)
        .single();

      if (error) {
        console.error('Error loading profile:', error);
        return;
      }

      userProfile = data;

      // Update UI
      document.getElementById('userEmail').textContent = currentUser.email;
      document.getElementById('userAvatar').textContent = currentUser.email.charAt(0).toUpperCase();

      const tierBadge = document.getElementById('tierBadge');
      tierBadge.textContent = data.tier.charAt(0).toUpperCase() + data.tier.slice(1);
      tierBadge.className = `tier-badge ${data.tier}`;

      document.getElementById('limitCount').textContent = data.monthly_request_limit.toLocaleString();
    }

    async function loadUsage() {
      const { data, error } = await supabase.rpc('get_usage_stats', {
        p_user_id: currentUser.id
      });

      if (error) {
        console.error('Error loading usage:', error);
        return;
      }

      const used = data.used || 0;
      const limit = data.limit || 1000;
      const remaining = data.remaining || limit;
      const percent = Math.round((used / limit) * 100);

      document.getElementById('usedCount').textContent = used.toLocaleString();
      document.getElementById('remainingCount').textContent = remaining.toLocaleString();
      document.getElementById('usagePercent').textContent = `${percent}%`;

      const progressBar = document.getElementById('progressBar');
      progressBar.style.width = `${percent}%`;
      if (percent >= 90) progressBar.classList.add('danger');
      else if (percent >= 75) progressBar.classList.add('warning');

      // Format reset date
      const resetDate = new Date(data.reset_date);
      document.getElementById('resetDate').textContent = resetDate.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });

      // Update remaining color
      const remainingEl = document.getElementById('remainingCount');
      remainingEl.className = 'stat-value';
      if (remaining === 0) remainingEl.classList.add('red');
      else if (remaining < limit * 0.1) remainingEl.classList.add('yellow');
      else remainingEl.classList.add('green');
    }

    // Toggle API key visibility
    document.getElementById('toggleKeyBtn').addEventListener('click', () => {
      apiKeyVisible = !apiKeyVisible;
      const keyEl = document.getElementById('apiKey');
      const curlKeyEl = document.getElementById('curlApiKey');

      if (apiKeyVisible) {
        keyEl.textContent = userProfile.api_key;
        keyEl.classList.remove('hidden');
        curlKeyEl.textContent = userProfile.api_key;
      } else {
        keyEl.textContent = 'sk_‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢';
        keyEl.classList.add('hidden');
        curlKeyEl.textContent = 'YOUR_API_KEY';
      }
    });

    // Copy API key
    document.getElementById('copyKeyBtn').addEventListener('click', async () => {
      await navigator.clipboard.writeText(userProfile.api_key);
      alert('API key copied to clipboard');
    });

    // Logout
    document.getElementById('logoutBtn').addEventListener('click', async () => {
      await supabase.auth.signOut();
      window.location.href = '/';
    });

    // Upgrade to paid plan
    async function upgradeToPlan(tier) {
      try {
        const response = await fetch('/api/checkout', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ userId: currentUser.id, tier })
        });

        const data = await response.json();

        if (data.url) {
          window.location.href = data.url;
        } else {
          alert('Failed to start checkout: ' + (data.error || 'Unknown error'));
        }
      } catch (error) {
        console.error('Checkout error:', error);
        alert('Failed to start checkout. Please try again.');
      }
    }

    // Open billing portal
    async function openBillingPortal() {
      try {
        const response = await fetch('/api/billing/portal', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ userId: currentUser.id })
        });

        const data = await response.json();

        if (data.url) {
          window.location.href = data.url;
        } else {
          alert('Failed to open billing portal: ' + (data.error || 'Unknown error'));
        }
      } catch (error) {
        console.error('Portal error:', error);
        alert('Failed to open billing portal. Please try again.');
      }
    }

    // Update plan actions based on current tier
    function updatePlanActions() {
      const actionsEl = document.getElementById('planActions');
      if (!userProfile) return;

      if (userProfile.tier === 'free') {
        actionsEl.innerHTML = `
          <a href="#" onclick="upgradeToPlan('pro'); return false;" style="color:var(--accent)">Upgrade to Pro</a>
        `;
      } else if (userProfile.tier === 'pro') {
        actionsEl.innerHTML = `
          <a href="#" onclick="upgradeToPlan('team'); return false;" style="color:var(--accent)">Upgrade to Team</a> |
          <a href="#" onclick="openBillingPortal(); return false;" style="color:var(--text-muted)">Manage</a>
        `;
      } else if (userProfile.tier === 'team' || userProfile.tier === 'enterprise') {
        actionsEl.innerHTML = `
          <a href="#" onclick="openBillingPortal(); return false;" style="color:var(--accent)">Manage Subscription</a>
        `;
      }
    }

    // Check for checkout success/cancel
    function checkCheckoutStatus() {
      const params = new URLSearchParams(window.location.search);
      if (params.get('checkout') === 'success') {
        alert('üéâ Subscription activated! Your plan has been upgraded.');
        window.history.replaceState({}, '', '/dashboard.html');
      } else if (params.get('checkout') === 'cancelled') {
        window.history.replaceState({}, '', '/dashboard.html');
      }
    }

    // Initialize
    checkCheckoutStatus();
    init().then(() => {
      updatePlanActions();
      initOnboarding();
    });

    // ===== ONBOARDING =====
    const STORAGE_PREFIX = 'stylemcp_';
    let selectedGoal = null;
    let completedSteps = [];

    function initOnboarding() {
      const userId = currentUser?.id || 'guest';
      
      // Check if welcome was shown
      const welcomeShown = localStorage.getItem(`${STORAGE_PREFIX}welcome_${userId}`);
      if (!welcomeShown) {
        document.getElementById('welcomeModal').classList.remove('hidden');
      }
      
      // Check completed steps
      const saved = localStorage.getItem(`${STORAGE_PREFIX}steps_${userId}`);
      completedSteps = saved ? JSON.parse(saved) : [];
      
      // Check if checklist was dismissed
      const dismissed = localStorage.getItem(`${STORAGE_PREFIX}checklist_dismissed_${userId}`);
      if (dismissed || completedSteps.length === 4) {
        document.getElementById('onboardingChecklist').classList.add('hidden');
      } else {
        updateChecklistUI();
      }
    }

    function selectGoal(goal) {
      selectedGoal = goal;
      document.querySelectorAll('.goal-btn').forEach(btn => btn.classList.remove('selected'));
      event.target.closest('.goal-btn').classList.add('selected');
      
      // Auto-dismiss after selection
      setTimeout(() => {
        dismissWelcome();
      }, 300);
    }

    function dismissWelcome() {
      const userId = currentUser?.id || 'guest';
      localStorage.setItem(`${STORAGE_PREFIX}welcome_${userId}`, 'true');
      if (selectedGoal) {
        localStorage.setItem(`${STORAGE_PREFIX}goal_${userId}`, selectedGoal);
      }
      document.getElementById('welcomeModal').classList.add('hidden');
    }

    function completeStep(stepNum) {
      if (!completedSteps.includes(stepNum)) {
        completedSteps.push(stepNum);
        const userId = currentUser?.id || 'guest';
        localStorage.setItem(`${STORAGE_PREFIX}steps_${userId}`, JSON.stringify(completedSteps));
        updateChecklistUI();
      }
    }

    function updateChecklistUI() {
      const total = 4;
      const completed = completedSteps.length;
      const progress = (completed / total) * 100;
      
      document.getElementById('progressFill').style.width = `${progress}%`;
      document.getElementById('checklistProgress').textContent = `${completed}/${total}`;
      
      // Update step states
      for (let i = 1; i <= 4; i++) {
        const step = document.getElementById(`step${i}`);
        if (completedSteps.includes(i)) {
          step.classList.add('completed');
        } else {
          step.classList.remove('completed');
        }
      }
      
      // Update CTA button
      const nextBtn = document.getElementById('nextStepBtn');
      const nextStep = [1, 2, 3, 4].find(s => !completedSteps.includes(s));
      if (nextStep) {
        const labels = {
          1: 'Copy API Key ‚Üí',
          2: 'Try API Call ‚Üí',
          3: 'View Style Packs ‚Üí',
          4: 'Read Docs ‚Üí'
        };
        nextBtn.textContent = labels[nextStep];
        nextBtn.style.display = 'block';
      } else {
        // All complete!
        document.getElementById('onboardingChecklist').innerHTML = `
          <div class="onboarding-complete">
            <h3>üéâ You're all set!</h3>
            <p style="color:var(--text-muted)">You've completed the getting started guide. Happy validating!</p>
          </div>
        `;
        setTimeout(() => {
          document.getElementById('onboardingChecklist').classList.add('hidden');
        }, 3000);
      }
    }

    function goToStep(stepNum) {
      switch (stepNum) {
        case 1:
          // Copy API key
          document.getElementById('copyKeyBtn').click();
          completeStep(1);
          break;
        case 2:
          // Scroll to quick start
          document.querySelector('.card:last-of-type').scrollIntoView({ behavior: 'smooth' });
          completeStep(2);
          break;
        case 3:
          // Open packs endpoint
          window.open('/api/packs', '_blank');
          completeStep(3);
          break;
        case 4:
          // Go to docs
          window.location.href = '/docs.html';
          completeStep(4);
          break;
      }
    }

    function goToNextStep() {
      const nextStep = [1, 2, 3, 4].find(s => !completedSteps.includes(s));
      if (nextStep) {
        goToStep(nextStep);
      }
    }

    function dismissChecklist() {
      const userId = currentUser?.id || 'guest';
      localStorage.setItem(`${STORAGE_PREFIX}checklist_dismissed_${userId}`, 'true');
      document.getElementById('onboardingChecklist').classList.add('hidden');
    }

    // Track API key copy as step 1
    const originalCopyHandler = document.getElementById('copyKeyBtn').onclick;
    document.getElementById('copyKeyBtn').addEventListener('click', () => {
      completeStep(1);
    });
  </script>
</body>
</html>
